{{extend 'layout.html'}}
{{block head}}
<link rel="stylesheet" href="{{=URL('static','css/home.css')}}" />
<!-- bootstrap-table -->
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-table.css')}}" />
<script src="{{=URL('static','js/bootstrap-table/bootstrap-table.js')}}"></script>
<script src="{{=URL('static','js/bootstrap-table/locales/bootstrap-table-fr-BE.min.js')}}"></script>
<!-- https://github.com/walmik/timer.jquery -->
<script src="{{=URL('static','js/validator.js')}}"></script>
<!-- www.eyecon.ro/bootstrap-datepicker/ -->
<script src="{{=URL('static','js/bootstrap-datepicker/bootstrap-datepicker.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-datepicker3.css')}}" />
<!-- https://github.com/walmik/timer.jquery -->
<script src="{{=URL('static','js/timer/timer.jquery.min.js')}}"></script>
<!-- https://github.com/datejs/Datejs -->
<script src="{{=URL('static','js/datejs/date.js')}}"></script>
<!-- https://github.com/silviomoreto/bootstrap-select.git -->
<script src="{{=URL('static','js/bootstrap-select/js/bootstrap-select.min.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','js/bootstrap-select/css/bootstrap-select.min.css')}}" />
{{end}}


<div class="container-fluid" id="div_wl">
  <div class="row">
    <div class="col-md-12">
      <div>
        <h1>Worklist from <span class="today"></span><span class="date_selection"><span class="date_after"></span> to <span class="date_before"></span></span></h1>
          <div class="toolbar_wl">
            <form id="search_date" class="form-inline">
            <span class="alert_wl"></span>
              <div class="form-group">
                <label class="">From:</label>
                <input type="date" class="form-control date" name="date_after" placeholder="Date from">
              </div>
              <div class="form-group">
                <label class="">to:</label>
                <input type="date" class="form-control date" name="date_before" placeholder="Date to">
              </div>
              <button type="submit" class="btn btn-primary submit">Search</button>
            </form>
          </div>
      </div>
      <table id="wl_table"
          data-id-field="id"
          data-show-refresh="true"
          data-show-columns="true"
          data-search="true"
          data-toggle="table"
          data-locale="en-US"
          data-detail-view="true"
          data-detail-formatter="detailFormatter_wl"
          data-response-handler="responseHandler_wl"
          data-query-params="queryParams"
          data-row-style="rowStyle"
          data-row-attributes="rowAttributes"
          data-pagination="true"
          data-toolbar="#div_wl .toolbar_wl">
        <thead>
          <tr>
            <th data-field="id" data-sortable="true">ID</th>
            <th data-field="patient" data-sortable="true">Patient</th>
            <th data-field="exam_description" data-formatter="examFormatter" data-title="Exam to do:" data-sortable="true">Exam to be done:</th>
            <th data-field="provider_OBR16" data-sortable="true">Provider:</th>
            <th data-field="receving_facility_MSH6" data-sortable="true">Receiving facility:</th>
            <th data-field="requested_time_OBR6" data-sortable="true">Timeslot:</th>
            <th data-field="modality_dest_OBR24" data-sortable="true" data-formatter="modalityFormatter">Modality destination:</th>
            <th data-field="status_flag" data-sortable="true">Status:</th>
            <th data-field="action_wl"
                data-align="center"
                data-formatter="actionFormatter_wl"
                data-events="actionEvents_wl">Action</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>


<div class="container-fluid" id="listing">
  <div class="row">
    <div class="col-md-12">
      <div>
        <h1>{{=group}}s</h1>
          <p class="toolbar">
            <a href="javascript:" class="create btn btn-default">New {{=group}}</a>
            <span class="alert_listing"></span>
          </p>
      </div>
      <table id="table"
          data-id-field="id"
          data-show-refresh="true"
          data-show-columns="true"
          data-search="true"
          data-toggle="table"
          data-detail-view="true"
          data-detail-formatter="detailFormatter"
          data-response-handler="responseHandler"
          data-query-params="queryParams"
          data-pagination="true"
          data-toolbar=".toolbar">
        <thead>
          <tr>
            <th data-field="id" data-sortable="true">ID</th>
            <th data-field="first_name" data-title="First name" data-sortable="true">First name:</th>
            <th data-field="last_name" data-sortable="true">Last name:</th>
            <th data-field="dob_pid7" data-sortable="true">Date of birth:</th>
            <th data-field="age" data-sortable="true">Age:</th>
            <th data-field="gender_pid8" data-sortable="true">Gender:</th>
            <th data-field="action"
                data-align="center"
                data-formatter="actionFormatter"
                data-events="actionEvents">Action</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>

<div class="container-fluid hidden">
<div class="row">
TEST
</div>
</div>


<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new_patient" role="form">
        <div class="modal-header">
          <button type="button" class="close btn btn-xs" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title .text-center" id="">New {{=group}}</span></h4>
        </div>
        <div class="modal-body">
          <div class="form-group hidden">
            <label>ID:</label>
            <input type="text" class="form-control user_id" name="id" placeholder="ID" value="">
          </div>
          <div class="row">
            <div class="form-group col-sm-6">
            <label>First name:</label>
            <div class="input-group">
              <input type="text" class="form-control first_name" name="first_name" placeholder="First name" value="" required>
            </div>
              <div class="help-block with-errors"></div>
            </div>
            <div class="form-group col-sm-6">
              <label>Last name:</label>
              <input type="text" class="form-control last_name" name="last_name" placeholder="Last name" required>
            </div>
          </div>
          <div class="form-group">
            <label>Maiden name</label>
            <input type="text" class="form-control maiden_name_pid6" name="maiden_name_pid6" placeholder="Maiden name">
          </div>
          <div class="form-group">
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="1" required>Male</label>
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="2" required>Female</label>
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="3" required>Undetermined</label>
          </div>
          <div class="form-group">
            <label for="inputEmail" class="control-label">Email:</label>
            <input type="email" class="form-control email_user" name="email" placeholder="email" id="inputEmail" data-error="Email address is required or invalid" required>
          </div>
          <div class="row">
              <div class="form-group col-sm-6">
                <label>Password:</label>
                <input type="password" class="form-control last_name" id="user_pass" name="password" placeholder="Password" data-minlenght="6" required>
                <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                <div class="help-block with-errors">Minimum of 6 characters</div>
              </div>
              <div class="form-group col-sm-6">
                <label>Confirm password:</label>
                <input type="password" class="form-control last_name" name="passwordcheck" placeholder="Password" data-match-error="Please match passwords" data-match="#user_pass">
                <div class="help-block with-errors"></div>
              </div>
          </div>
          <div class="row">
            <div class="form-group col-sm-4">
              <label>Date of birth:</label>
              <div class="input-group">
                <!-- <div class="input-group-addon"><span class=" glyphicon glyphicon-th" onclick="$('#new_patient .datepicker').datepicker('show');"></span></div> -->
                <input type="text" class="form-control dob_pid7 date" pattern="^\d{4}-((0[1-9])|(1[012]))-((0[1-9]|[12]\d)|3[01])$" name="dob_pid7" placeholder="YYYY-MM-DD" required>
              </div>
            </div>
            <div class="form-group col-sm-4">
              <label>Town of birth:</label>
              <input type="text" class="form-control birth_town_pid23" name="birth_town_pid23" placeholder="Town of birth">
            </div>
            <div class="form-group col-sm-4">
              <label>Country of birth:</label>
              <input type="text" class="form-control birth_country_pid23" name="birth_country_pid23" placeholder="Country of birth">
            </div>
          </div>
            <div class="row">
              <div class="form-group col-sm-6">
                <label>ID card number:</label>
                <input type="text" class="form-control idc_num" name="idc_num" placeholder="ID card number">
              </div>
              <div class="form-group col-sm-6">
                <label>Social security number:</label>
                <input type="text" class="form-control ssn_pid19" name="ssn_pid19" placeholder="Social security number">
              </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning pull-left" onclick="resetForm($('#new_patient'));">Reset</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary submit">Submit</button>
          <span class="duplicate"><button type="button" class="btn btn-danger" id="check_duplicate">{{=group}} may exists, OK to create?</button></span>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_wl" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form_wl">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Task #<span class="message_unique_id_MSH10"></span> for <span class="patient"></span></h4>
      </div>
      <div class="modal-body">
        <div class="form-group hidden">
          <label>Task ID:</label>
          <input type="text" class="form-control id" name="id" placeholder="Task ID" value="">
        </div>
        <div class="form-group hidden">
          <label>patient ID:</label>
          <input type="text" class="form-control id_auth_user" name="id_auth_user" placeholder="Patient ID" value="">
        </div>
        <div class="row">
          <div class="form-group col-sm-6">
          <label>Sender:</label>
          <div class="input-group">
            <select class="form-control sending_facility_MSH4 selectpicker" name="sending_facility_MSH4">
            </select>
          </div>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group col-sm-6">
            <label>receiver:</label>
            <div class="input-group">
              <select class="form-control receving_facility_MSH6 selectpicker" name="receving_facility_MSH6">
              </select>
            </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-12">
          <label>Exam to be done:</label>
          <div class="input-group">
            <select class="form-control exam2do_OBR4 selectpicker" data-live-search="true" name="exam2do_OBR4">
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-12">
          <label>Laterality:<span style="color: red;" class="lat_req"></span></label>
          <div class="input-group">
            <div class="btn-group laterality" data-toggle="buttons">
            <label class="btn btn-primary">
              <input type="radio" class="laterality_left" name="laterality" autocomplete="off" value="left">Left
            </label>
            <label class="btn btn-primary">
              <input type="radio" class="laterality_both" name="laterality" autocomplete="off" value="both">Both
            </label>
            <label class="btn btn-primary">
              <input type="radio" class="laterality_none" name="laterality" autocomplete="off" value="none">None
            </label>
            <label class="btn btn-primary">
              <input type="radio" class="laterality_right" name="laterality" autocomplete="off" value="right">Right
            </label>
            <div class="help-block with-errors">Required <span id="alert_lat" style="color:red;"></span></div>
            </div>
         </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-12">
          <label>Modality:</label>
          <div class="input-group">
            <select class="form-control modality_dest_OBR24 selectpicker" data-live-search="true" name="modality_dest_OBR24">
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-12">
          <label>Provider:</label>
          <div class="input-group">
            <select class="form-control provider_OBR16 selectpicker" data-live-search="true" name="provider_OBR16">
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-12">
          <label>Timeslot:</label>
          <div class="input-group-group">
            <input type="text" class="form-control requested_time_OBR6 datetime" name="requested_time_OBR6" placeholder="Timeslot" value="">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-sm-4">
          <label>Status:</label>
          <div class="input-group">
            <select class="form-control status_flag selectpicker" name="status_flag">
              <option value="requested">Requested</option>
              <option value="in process">In process</option>
              <option value="done">Done</option>
              <option value="cancelled">cancelled</option>
            </select>
          </div>
        </div>
        <div class="form-group col-sm-12">
          <label>Warning:</label>
          <div class="input-group-group">
            <input type="text" class="form-control warning" name="warning" placeholder="Warning" value="">
          </div>
        </div>
        <div class="form-group col-sm-3">
          <label>Counter:</label>
          <div class="input-group">
            <span class="input-group-addon btn btn-info counter_down">-</span>
            <input type="text" class="form-control counter" name="counter" placeholder="Count" value="0">
            <span class="input-group-addon btn btn-info counter_up">+</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary submit">Submit</button>
      </div>
    </div>
  </form>
  </div>
</div>

<script type="text/javascript">
  var facilities = {{=facilities}}, exams = {{=exams}}, modalities = {{=modalities}}, providers_req = {{=providers}};
  providers = concatFirstLastname(providers_req);
  var API_URL = '{{=URL('api','users/membership/'+membership+'/user', scheme=True, host=True)}}';
  var $table = $('#table').bootstrapTable({
        url:'{{=URL('api','users_list/'+membership, scheme=True, host=True)}}'}),
      $table_wl = $('#wl_table').bootstrapTable({
        url: '{{=URL('api','wl', scheme=True, host=True)}}'
      });
  var $alert = $('.alert_listing').hide();
  var $alert_wl = $('.alert_wl').hide();
  var timer_id = [];
  $('.date_selection').hide();

  $('.today').text(Date.today().toString('yyyy-M-d'));

  $(".btn.counter_down").click(function() {
    value = parseInt($("input.counter").val());
    if (value >= 1) {
      $("input.counter").val(value-1);
    } else {};
  });

  $(".btn.counter_up").click(function() {
    value = parseInt($("input.counter").val());
    if (value >= 0) {
      $("input.counter").val(value+1);
    } else {};
  });


  $(function() {
    var $modal = $('#modal').modal({show: false}),
      $modal_wl = $('#modal_wl').modal({show: false});
    var $duplicate = $('.duplicate').hide();
    resetForm($('#new_patient'));
    $("body").tooltip({ selector: '[data-toggle=tooltip]' });

    $modal.on('hidden.bs.modal', function (){
      $('.submit').show();
      $duplicate.hide();
    });

    $('#new_patient .datepicker','#form_wl .datepicker').datepicker({
                    format: "yyyy-mm-dd"
                });

    $('#modal', '#modal_wl')
      .on('shown.bs.modal', function (e) {
        $('#modal_wl').selectpicker('show')
        $('#new_patient').validator();
        $('#new_patient .datepicker').datepicker({
                        format: "yyyy-mm-dd"
                    });
        $('#modal_wl').validator();
        $('#modal_wl .datepicker').datepicker({
                        format: "yyyy-mm-dd"
                    });
          })
      .on('hidden.bs.modal', function (e) {
        $('#new_patient').validator('destroy');
        $('#new_patient .datepicker').datepicker('destroy');
        $('#modal_wl').validator('destroy');
        $('#modal_wl .datepicker').datepicker('destroy');
        $('#modal_wl').selectpicker('destroy');
        });

    $('.create').click(function () {
      $modal.modal('show');
    });

    $('#search_date .submit').click(function(e){
      e.preventDefault(); // on empeche l'envoi du formulaire par le navigateur
      date_after= $('#search_date input[name=date_after]').val();
      date_before= $('#search_date input[name=date_before]').val();
      $('.today').hide();
      $('.date_selection').show();
      $('.date_selection span.date_after').text(date_after);
      $('.date_selection span.date_before').text(date_before);
      $table_wl.bootstrapTable('refresh',
        {url: '{{=URL('api','wl', scheme=True, host=True)}}?date_after='+date_after+'&date_before='+date_before}
      );
    })

    $modal.find('.submit').click(function (e) {
      if ( $('#new_patient .submit').hasClass('disabled'))
        { e.preventDefault();
          return true;
        }
      else {
        var row = {};
        e.preventDefault(); // on empeche l'envoi du formulaire par le navigateur
        $modal.find('input[name]').each(function () {
          row[$(this).attr('name')] = $(this).val();
        });
        row['gender_pid8'] = $('input:radio[name=gender_pid8]').filter(':checked').val();
        row['first_name'] = titleCase($('input[name=first_name]').val());
        row['last_name'] = titleCase($('input[name=last_name]').val());
        delete row['passwordcheck'];
        check_duplicate(encodeURIComponent(row['first_name']),encodeURIComponent(row['last_name']),row['dob_pid7'],row);
      }
    });

    $modal_wl.find('.submit').click(function (e) { // create or edit a worklist item
      if ( $('#form_wl .submit').hasClass('disabled'))
        {
          e.preventDefault();
          $('.alert_lat').text('Class disabled error');
          return true;
        }
        else {
        var row = {}, req;
        e.preventDefault(); // on empeche l'envoi du formulaire par le navigateur
        $('#form_wl').find('input[name]').each(function () {
          row[$(this).attr('name')] = $(this).val();
        });
        $('#form_wl').find('select[name]').each(function () {
          row[$(this).attr('name')] = $(this).val();
        });
        if (!$('input:radio[name=laterality]').filter(':checked').val()) {
          $('.alert_lat').text('Please set laterality');
          return true;
        } else {
        row['laterality']= $('input:radio[name=laterality]').filter(':checked').val();
        };
        if (row['id'] == '') {
          req = 'POST';
          delete row['id'];
          console.log('POST')
          console.log(row);
          post_wl_form(row,req);
        } else {
          req = 'PUT';
          delete row['id_auth_user'];
          console.log('PUT')
          console.log(row);
          post_wl_form(row,req);
          }
        }
    });

    function post_new_user_form(row) {
      var API_URL = '{{=URL('api','users/auth_user', scheme=True, host=True)}}/';
      $.ajax({
        url: API_URL,
        type: 'post',
        contentType: 'application/json',
        data: JSON.stringify(row),
        success: function (text) {
          id = text.slice(text.indexOf('id(')+3,text.indexOf(') ***'));
          if ( id == 'None') {
            $modal.modal('hide');
            showAlert('Unable to add new patient!','danger', 'alert_listing');
          } else {
          add_membership(id,2);
          $modal.modal('hide');
          resetForm($('#new_patient'));
          $table.bootstrapTable('refresh');
          showAlert('Created','success', 'alert_listing');
          }
          },
          error: function () {
            $modal.modal('hide');
            showAlert('Unable to add new patient!','danger', 'alert_listing');
          }
        });
    }

    function check_duplicate(first,last,dob,row) { // check duplicate with first_name last_name dob
      var API_URL = '{{=URL('api','users/user', scheme=True, host=True)}}/'+encodeURIComponent(first)+ '/' +encodeURIComponent(last)+ '/' +dob;
      $.ajax({
        url: API_URL,
        type: 'get',
        contentType: 'application/json',
        dataType: "json",
        success: function(data) {
          duplicate_list = data.content;
          if ( jQuery.isEmptyObject(duplicate_list) == true) {
            console.log('Not a duplicate');
            post_new_user_form(row); }
          else {
            console.log('Duplicate check');
            $duplicate.show();
            $('.submit').hide();
            $('#check_duplicate').click( function(){
            post_new_user_form(row);
            $('.submit').show();
            $duplicate.hide();
            });
          }
        },
        error: function () {
          showAlert('Unable to check if duplicate!','danger', 'alert_listing');
        }
      });
    }

    function post_wl_form(row,req) { // create or edit a wl item in db
      var API_URL = (req == 'POST' ? '{{=URL('api','wl/worklist', scheme=True, host=True)}}/' : '{{=URL('api','wl/worklist', scheme=True, host=True)}}/'+ row.id);
      var mode = (req == 'POST' ? 'add':'edit');
      $.ajax({
        url: API_URL,
        type: req == 'POST' ? 'post':'put',
        contentType: 'application/json',
        data: JSON.stringify(row),
        success: function (text) {
          id = text.slice(text.indexOf('id(')+3,text.indexOf(') ***'));
          if ( id == 'None') {
            $modal_wl.modal('hide');
            showAlert('Unable to '+mode+' task','danger','alert_wl');
          } else {
          $modal_wl.modal('hide');
          resetForm($('#form_wl'));
          $table_wl.bootstrapTable('refresh');
          showAlert(titleCase(mode+'ed'),'success','alert_wl');
          }
          },
          error: function () {
            $modal_wl.modal('hide');
            showAlert('Unable to '+mode+'  task!','danger','alert_wl');
          }
        });
    }

    $('#wl_table').on('post-body.bs.table', function () {
      set_timers(timer_id);
    });

  }); // document.ready

    //window.actionEvents not working if in the document.ready
    window.actionEvents = {
      'click .update': function (e,value,row) {
        location.href = '{{=URL('default','oph2py01/file', scheme=True, host=True)}}/'+row.id;
      },
      'click .remove': function (e, value, row) {
          if (confirm('Are you sure to delete this item?')) {
              $.ajax({
                  url: '{{=URL('api','users/auth_user', scheme=True, host=True)}}/'+ row.id,
                  type: 'delete',
                  success: function () {
                      $table.bootstrapTable('refresh');
                      showAlert('Delete item successful!', 'success', 'alert_listing');
                  },
                  error: function () {
                      showAlert('Delete item error!', 'danger', 'alert_listing');
                  }
              })
          }
      },
      'click .open':function (e,value,row) {
        location.href ='{{=URL('default','file', scheme=True, host=True)}}/'+row.id;
      },
      'click .worklist':function (e,value,row) {
        resetForm($('#form_wl'));
        setSelect('#form_wl select.exam2do_OBR4', exams, 'exam_description');
        setSelect('#form_wl select.sending_facility_MSH4', facilities, 'facility_name');
        setSelect('#form_wl select.receving_facility_MSH6', facilities, 'facility_name');
        setSelect('#form_wl select.provider_OBR16', providers, 'name');
        setSelect('#form_wl select.modality_dest_OBR24', modalities, 'modality_name');
        $('#form_wl .id_auth_user').val(row.id);
        $('#form_wl .provider_OBR16').val(72);
        $('#form_wl .patient').text(row.last_name + ' '+row.first_name);
        $('#form_wl .counter').val(!row.cycle_num ? '1': row.cycle_num);
        $('.selectpicker').selectpicker('refresh');
        $('#modal_wl').modal('show');
      }
    }

    window.actionEvents_wl = {
      'click .update': function (e,value,row) { // set values of wl item to pass to an edit modal form
        resetForm($('#form_wl'));
        setSelect('#form_wl select.exam2do_OBR4', exams, 'exam_description');
        setSelect('#form_wl select.sending_facility_MSH4', facilities, 'facility_name');
        setSelect('#form_wl select.receving_facility_MSH6', facilities, 'facility_name');
        setSelect('#form_wl select.provider_OBR16', providers, 'name');
        setSelect('#form_wl select.modality_dest_OBR24', modalities, 'modality_name');
        $('#form_wl .patient').text(row.patient);
        $('#form_wl .id').val(row.id);
        $('#form_wl .id_auth_user').val(row.id_auth_user);
        $('#form_wl .message_unique_id_MSH10').text(row.message_unique_id_MSH10);
        $('#form_wl input.requested_time_OBR6').val(row.requested_time_OBR6);
        $('#form_wl select.sending_facility_MSH4').val(row.sending_facility_MSH4);
        $('#form_wl select.receving_facility_MSH6').val(row.receving_facility_MSH6);
        $('#form_wl select.exam2do_OBR4').val(row.exam2do_OBR4);
        $('#form_wl select.provider_OBR16').val(row.provider_id);
        $('#form_wl select.status_flag').val(row.status_flag);
        $('#form_wl input.warning').val(row.warning);
        console.log('before init '+row.laterality)
        !row.counter ? $('#form_wl input.counter').val('0') : $('#form_wl input.counter').val(row.counter);
        !row.laterality? $('#form_wl input.laterality_both').prop('checked',true).parent().addClass('active') : $('#form_wl input.laterality_'+row.laterality).prop('checked',true).parent().addClass('active');
        $('input:radio[name=laterality]').val(!row.laterality? 'both':row.laterality);
        console.log('after init '+$('input:radio[name=laterality]').val());
        $('.selectpicker').selectpicker('refresh');
        $('#modal_wl').modal('show');
      },
      'click .done': function (e,value,row) { // set task to done
        simple_row = {id: row.id, status_flag: 'done'};
        $.ajax({
          url:  '{{=URL('api','wl/worklist', scheme=True, host=True)}}/'+ row.id,
          type: 'put',
          contentType: 'application/json',
          data: JSON.stringify(simple_row),
          success: function (text) {
            id = text.slice(text.indexOf('id(')+3,text.indexOf(') ***'));
            if ( id == 'None') {
              showAlert('Unable to set task','danger','alert_wl');
            } else {
            $table_wl.bootstrapTable('refresh');
            showAlert(titleCase('Task set to DONE'),'success','alert_wl');
            }
            },
            error: function () {
              showAlert('Unable to set task to done!','danger','alert_wl');
            }
          });
      },
      'click .processing': function (e,value,row) { // set task to processing
        simple_row = {id: row.id};
        flag = 'in process';
        if (row.counter >= 1) {
          simple_row['counter'] = parseInt(row.counter,10)-1;
        } else if (row.counter == 1){
          simple_row['counter'] = parseInt(row.counter,10)-1;
        } else {
          flag = 'done';
        };
        simple_row['status_flag'] = flag;
        console.log(row);
        $.ajax({
          url:  '{{=URL('api','wl/worklist', scheme=True, host=True)}}/'+ row.id,
          type: 'put',
          contentType: 'application/json',
          data: JSON.stringify(simple_row),
          success: function (text) {
            id = text.slice(text.indexOf('id(')+3,text.indexOf(') ***'));
            if ( id == 'None') {
              showAlert('Unable to set task','danger','alert_wl');
            } else {
            $table_wl.bootstrapTable('refresh');
            showAlert(titleCase('Task set as '+flag),'success','alert_wl');
            }
            },
            error: function () {
              showAlert('Unable to set task as '+flag,'danger','alert_wl');
            }
          });
      },
      'click .remove': function (e, value, row) { // delete a wl item in db
          if (confirm('Are you sure to delete this item?')) {
              $.ajax({
                  url: '{{=URL('api','wl/worklist', scheme=True, host=True)}}/'+ row.id,
                  type: 'delete',
                  success: function () {
                      $table_wl.bootstrapTable('refresh');
                      showAlert('Delete item successful!', 'success', 'alert_wl');
                  },
                  error: function () {
                      showAlert('Delete item error!', 'danger', 'alert_wl');
                  }
              })
          }
      }
    }


  function showAlert(title, type, div) { // show alert function
    $('.'+div).attr('class', div+' alert alert-' + type || 'success')
          .html('<i class="glyphicon glyphicon-check"></i> ' + title).show();
    setTimeout(function () {
        $('.'+div).hide();
      }, 5000);
  }

  function add_membership(user_id,membership) { // set membership to user_id
    var row = {'user_id': user_id, 'group_id': {{=membership}}};
    $.ajax({
      url: '{{=URL('api','users/auth_membership', scheme=True, host=True)}}/',
      type: 'post',
      contentType: 'application/json',
      data: JSON.stringify(row),
      success: function (text) {
        console.log(text);
      },
      error: function () {
        showAlert('Unable to set membership!','danger', 'alert_listing');
      }
    });
  }

// for data in tables

  function responseHandler(res) {
    list = res.content;
    display = [];
    $.each(list, function(i) {
      display.push({'id': list[i].user.id,
       'first_name': list[i].user.first_name,
       'last_name': list[i].user.last_name,
       'dob_pid7': list[i].user.dob_pid7,
       'gender_pid8': list[i].gender.sex,
       'age': getAge(list[i].user.dob_pid7)
      });
    });
    return display;
  }

  function responseHandler_wl(res) {
    worklist = res.content;
    display = [];
    $.each(worklist, function(i) {
      display.push({'id': worklist[i].worklist.id,
       'provider_OBR16': worklist[i].provider.first_name+' '+worklist[i].provider.last_name,
       'provider_id': worklist[i].provider.id,
       'patient': worklist[i].patient.first_name+' '+worklist[i].patient.last_name,
       'id_auth_user': worklist[i].worklist.id_auth_user,
       'receving_facility_MSH6': worklist[i].receiver.facility_name,
       'sending_facility_MSH4': worklist[i].sender.facility_name,
       'message_unique_id_MSH10': worklist[i].worklist.message_unique_id_MSH10,
       'requested_time_OBR6': worklist[i].worklist.requested_time_OBR6,
       'status_flag': worklist[i].worklist.status_flag,
       'requested_time_OBR6': worklist[i].worklist.requested_time_OBR6,
       'modality_dest_OBR24': worklist[i].modality.modality_name,
       'created_by': worklist[i].creator.first_name+' '+worklist[i].creator.last_name,
       'created_on': worklist[i].worklist.created_on,
       'modified_by': worklist[i].editor.first_name+' '+worklist[i].editor.last_name,
       'modified_on': worklist[i].worklist.modified_on,
       'exam2do_OBR4': worklist[i].exam2do_OBR4.id,
       'controller': worklist[i].exam2do_OBR4.controller,
       'exam_description': worklist[i].exam2do_OBR4.exam_description,
       'counter': worklist[i].worklist.counter,
       'procedure_seq': worklist[i].exam2do_OBR4.procedure_seq,
       'cycle_num': worklist[i].exam2do_OBR4.cycle_num,
       'laterality': worklist[i].worklist.laterality,
       'warning': worklist[i].worklist.warning
      });
    });
    return display;
  }

  function detailFormatter(index, row) {
    var html = [];
    label = {id: 'ID', first_name: 'First name', last_name: 'Last name',
              dob_pid7: 'Date of birth', age: 'age', gender_pid8: 'Gender'
              };
    $.each(row, function (key, value) {
      if (!(key in label)) {} else {
        html.push('<p><b>' + label[key] + ':</b> ' + value + '</p>'); }
      });
    // html.splice(0, 0, html.splice(3,1)[0]); // arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
    return html.join('');
  }

  function detailFormatter_wl(index, row) {
    var html = [];
    label = {id: 'ID', exam_description: 'Exam to be done', provider_OBR16: 'Provider', receving_facility_MSH6: 'Department',
              requested_time_OBR6: 'Timeslot', modality_dest_OBR24: 'Modality destination', status_flag: 'Status'
            };
    $.each(row, function (key, value) {
      if (!(key in label)) {} else {
        html.push('<p><b>' + label[key] + ':</b> ' + value + '</p>'); }
      });
    return html.join('');
  }

  function queryParams(params) {
      return {};
  }

  function actionFormatter(value) {
      return [
          '<a class="open" href="javascript:" title="Open user details"><i class="glyphicon glyphicon-user"></i></a>  ',
          '<a class="examination" href="javascript:" title="New examination"><i class="glyphicon glyphicon-star-empty"></i></a>',
          '<a class="billing" href="javascript:" title="Billing"><i class="glyphicon glyphicon-euro"></i></a>',
          '<a class="worklist pull-right" href="javascript:" title="Add to worklist"><i class="glyphicon glyphicon-download-alt"></i></a>',
          '<a class="remove" href="javascript:" title="Delete"><i class="glyphicon glyphicon-remove-circle"></i></a>'
      ].join('');
  }

  function actionFormatter_wl(value,row) {
      var API_URL = '{{=URL('exams','none', scheme=True, host=True)}}'
      API_URL = API_URL.slice(0,-5);
      return [
          '<a class="update" href="javascript:" title="Update task"><i class="glyphicon glyphicon-pencil"></i></a>  ',
          '<a class="remove" href="javascript:" title="Delete task"><i class="glyphicon glyphicon-remove-circle"></i></a>',
          '<a class="processing" href="javascript:" title="Set task as in process"><i class="glyphicon glyphicon-time"></i></a>',
          '<a class="details" href="'+API_URL+'/'+row.controller+'?id_auth_user='+row.id_auth_user+'&id_worklist='+row.id+'" title="Details"><i class="glyphicon glyphicon-plus"></i></a>',
          '<a class="done" href="javascript:" title="Set task as done"><i class="glyphicon glyphicon-ok"></i></a>'
      ].join('');
  }

  function rowStyle(row, index) {
      var classes = ['active', 'success', 'info', 'warning', 'danger'];
      if (row.status_flag == 'requested') {
          return { classes: classes[4] };
      } else if (row.status_flag== 'in process') {
          return { classes: classes[2] };
      } else if (row.status_flag== 'done') {
          return { classes: classes[1] };
      } else if (row.status_flag== 'cancelled') {
          return { classes: classes[3] };
      }
      return {};
  }

  function rowAttributes(row,index) { // set tooltip values
    row.created_by == '' ? createdby = 'created by unknown' : createdby = 'created by '+row.created_by;
    row.created_on == '' ? createdon = ' on unknown date' : createdon = ' on '+row.created_on;
    row.modified_by == '' ? modifiedby = ' modified by unknown' : modifiedby = ' modified by '+row.modified_by;
    row.modified_on == '' ? modifiedon = ' on unknown date' : modifiedon = ' on '+row.modified_on;
    return { "title": createdby + createdon + modifiedby + modifiedon,
      "data-toggle": "tooltip"
    };
  }

  function modalityFormatter(value,row) {
    html = [];
    lastmodif = Date.parse(row.modified_on);
    var rightnow = new Date();
    elapse = Math.round((lastmodif.getElapsed()-rightnow.getElapsed())/1000);
    timer_id.push('#timer_'+row.id);
    if ( !row.counter ) {
      html.push(value+'<div class="pull-right">');
    } else {
      html.push(value+'<div class="pull-right"><span class="badge badge-counter">'+row.counter+'</span>');
    }
    html.push('<span id="timer_'+row.id+'" class="badge badge-timer" style="color: red;">'+elapse+'</span></div>');
    return html.join('');
  }

  function examFormatter(value,row) {
    html = [];
    html.push(value+'<div class="pull-right">');
    if (!row.procedure_seq) { }
    else { html.push('<div class="pull-right"><span class="badge badge-procedure">'+row.procedure_seq+'</span>')};
    if (!row.warning) { }
    else { html.push('<div class="pull-right"><span class="badge badge-warning">'+row.warning+'</span>')};
    html.push('<span class="badge badge-laterality">'+row.laterality+'</span></div>');
    return html.join('');
  }

  function set_timers(timers) {
    $.each(timers, function(i){
      $(timers[i]).timer({
        seconds: $(timers[i]).text()
      });
    });
    timer_id = [];
  }

  function titleCase(string) {
    return string.charAt(0).toUpperCase() + string.slice(1); }

    function getAge(dateString) {
      var today = new Date();
      var birthDate = new Date(dateString);
      var age = today.getFullYear() - birthDate.getFullYear();
      var m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          age--;
      }
      return age;
  }

  function setSelect(id,rows,description) {
    var items = rows.content;
    html = [];
    $.each(items, function(i){
      html.push('<option value="'+items[i]['id']+'" data-tokens="'+items[i][description].split(" ",2)+'">'+items[i][description]+'</option>');
    });
    $(id).html(html.join(''));
    $('.selectpicker').selectpicker('refresh');
  }

  function concatFirstLastname(rows) {
    var items = rows.content;
    var result = {content:[]};
    result2 = [];
    $.each(items, function(i) {
      result['content'].push({'id':items[i]['id'],'name':items[i]['first_name']+' '+items[i]['last_name']});
    });
    return result;
  }

  function resetForm($form) {
    $form.find('input:text, input:password, input:file, select, textarea').val('');
    $form.find('input:radio, input:checkbox')
       .removeAttr('checked').removeAttr('selected').parent().removeClass('active');
  }
</script>
